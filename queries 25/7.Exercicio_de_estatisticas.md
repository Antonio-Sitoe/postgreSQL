# PARTE C — 10 exercícios avançados de estatísticas

1. **Valor total e valor médio de lançamentos por cliente (ordenado pelo total).**

```sql
SELECT id_cliente,
       COUNT(*) AS qtd_lancamentos,
       SUM(valor) AS total_valor,
       AVG(valor) AS media_valor
FROM lancamento
GROUP BY id_cliente
ORDER BY total_valor DESC;
```

2. **Desvio padrão e variância do valor dos lançamentos.**

```sql
SELECT STDDEV_POP(valor) AS desvio_pop,
       STDDEV_SAMP(valor) AS desvio_amostral,
       VAR_POP(valor) AS variancia_pop
FROM lancamento;
```

3. **Faturamento mensal (soma de `valor` por mês).**

```sql
SELECT date_trunc('month', data_lancamento) AS mes,
       SUM(valor) AS faturamento
FROM lancamento
GROUP BY 1
ORDER BY 1;
```

4. **Top 5 clientes que geraram maior receita (Pareto: 20% que respondem por 80%).**

```sql
WITH cliente_total AS (
  SELECT id_cliente, SUM(valor) AS total
  FROM lancamento
  GROUP BY id_cliente
),
tot AS (SELECT SUM(total) AS faturamento_total FROM cliente_total)
SELECT ct.id_cliente, ct.total,
       ct.total / tot.faturamento_total AS percent_faturamento
FROM cliente_total ct, tot
ORDER BY ct.total DESC
LIMIT (SELECT GREATEST(1, CEIL(COUNT(*) * 0.20)) FROM cliente_total);
```

_(alternativa: calcular cumulativo e pegar até 80%)_

5. **Percentual de lançamentos PAGO vs PENDENTE.**

```sql
SELECT situacao,
       COUNT(*) AS qtd,
       100.0 * COUNT(*) / SUM(COUNT(*)) OVER () AS percent
FROM lancamento
GROUP BY situacao;
```

6. **Mediana e percentis (Q1, Q3) do `valor` (usando `percentile_cont`).**

```sql
SELECT
  percentile_cont(0.5) WITHIN GROUP (ORDER BY valor) AS mediana,
  percentile_cont(0.25) WITHIN GROUP (ORDER BY valor) AS q1,
  percentile_cont(0.75) WITHIN GROUP (ORDER BY valor) AS q3
FROM lancamento;
```

7. **Crescimento percentual mensal (mês sobre mês).**

```sql
WITH mensal AS (
  SELECT date_trunc('month', data_lancamento) AS mes,
         SUM(valor) AS faturamento
  FROM lancamento
  GROUP BY 1
)
SELECT mes,
       faturamento,
       LAG(faturamento) OVER (ORDER BY mes) AS faturamento_prev,
       CASE WHEN LAG(faturamento) OVER (ORDER BY mes) IS NULL THEN NULL
            ELSE 100.0 * (faturamento - LAG(faturamento) OVER (ORDER BY mes)) / LAG(faturamento) OVER (ORDER BY mes)
       END AS crescimento_percent
FROM mensal
ORDER BY mes;
```

8. **Relação entre número de parcelas e valor total: média por parcela.**

```sql
SELECT parcela, COUNT(*) AS qtd, AVG(valor) AS media_valor, AVG(valor / NULLIF(parcela,0)) AS media_por_parcela
FROM lancamento
GROUP BY parcela
ORDER BY parcela;
```

9. **Desvio padrão do total por categoria (para identificar categorias voláteis).**

```sql
SELECT id_categoria,
       SUM(valor) AS total_categoria,
       STDDEV_POP(valor) AS desvio_valor
FROM lancamento
GROUP BY id_categoria
ORDER BY desvio_valor DESC NULLS LAST;
```

10. **Clientes que representam os 80% superiores de faturamento (cálculo cumulativo).**

```sql
WITH t AS (
  SELECT id_cliente, SUM(valor) AS total
  FROM lancamento
  GROUP BY id_cliente
),
ordered AS (
  SELECT id_cliente, total,
         SUM(total) OVER (ORDER BY total DESC) AS cumul_total,
         SUM(total) OVER () AS total_geral
  FROM t
)
SELECT id_cliente, total, cumul_total, total_geral,
       cumul_total / total_geral AS cumul_fraction
FROM ordered
WHERE cumul_total / total_geral <= 0.8
ORDER BY total DESC;
```
